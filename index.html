<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PO → Offline Excel (URL Images, Correct Sizing)</title>
<style>
  :root { --pad:14px; --grid:#ddd; --ink:#111; --muted:#666; }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body{margin:0;background:#f6f7f8;color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:var(--pad);display:grid;gap:var(--pad)}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{padding:8px 12px;border:1px solid var(--ink);background:var(--ink);color:#fff;border-radius:8px;cursor:pointer}
  .card{background:#fff;border:1px solid var(--grid);border-radius:10px;overflow:hidden}
  .card h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--grid);background:#fafafa}
  .card .inner{padding:12px}

  .a4{background:#fff;border:1px solid var(--grid);border-radius:8px;padding:12mm}

  .letterhead{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .logo{height:48px;display:flex;align-items:center;gap:10px}
  .logo img{height:48px;width:auto;display:block}
  .company h1{font-size:18px;line-height:1.1;margin:0}
  .company .sub{font-size:12px;color:var(--muted)}
  .doc-title{text-align:right}
  .doc-title h2{margin:0;font-size:22px}
  .doc-title .code{font-size:12px;color:var(--muted)}

  .info{display:grid;grid-template-columns:160px 1fr 160px 1fr;gap:6px 10px;margin:8px 0 12px}
  .info .k{color:#444}
  .info .v{font-weight:600}

  .remarks{border:1px dashed #bbb;border-radius:8px;padding:10px;margin:8px 0 14px;background:#fcfcfc}
  .remarks h3{margin:0 0 6px 0;font-size:14px}
  .remarks p{margin:0;font-size:13px;color:#333}

  table{width:100%;border-collapse:collapse;table-layout:fixed}
  th,td{border:1px solid #000;padding:4px 6px;vertical-align:top}
  th{background:#e9ecef;text-align:center}
  .right{text-align:right}
  .center{text-align:center}
  .imgbox{width:120px;height:120px;display:flex;align-items:center;justify-content:center}
  .imgbox img{max-width:100%;max-height:100%;display:block}

  .footer{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:12px}
  .footnote{font-size:12px;color:#555}
  .footlogo img{height:32px;width:auto;display:block}

  .note{font-size:12px;color:#555}
</style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
       <button id="exportBtn">Export Full Page to Excel (.xlsx)</button>
       <span id="status" class="note"></span>
     </div>

    <div class="card">
      <h2>Purchase Order – URL Images Demo</h2>
      <div class="inner">
        <div class="a4">
          <!-- Letterhead -->
          <div class="letterhead">
            <div class="logo">
              <img alt="Company Logo" crossorigin="anonymous"
                   src="https://picsum.photos/seed/logo1/320/96">
              <div class="company">
                <h1>Acme Metals Pte Ltd</h1>
                <div class="sub">UEN: 201912345Z · 123 Pioneer Ave, Singapore · +65 6123 4567</div>
              </div>
            </div>
            <div class="doc-title">
              <h2>PURCHASE ORDER</h2>
              <div class="code">Form: PO-STD-001</div>
            </div>
          </div>

          <!-- Document Info -->
          <div class="info">
            <div class="k">PO No.</div><div class="v">PO-2025-000123</div>
            <div class="k">Date</div><div class="v">2025-09-29</div>
            <div class="k">Supplier</div><div class="v">Steel & Co. Sdn Bhd</div>
            <div class="k">Ship To</div><div class="v">Acme Warehouse, Jurong</div>
            <div class="k">Currency</div><div class="v">SGD</div>
            <div class="k">Buyer</div><div class="v">Wei Jun</div>
          </div>

          <!-- Remarks -->
          <div class="remarks">
            <h3>Remarks</h3>
            <p>Deliver within 7 working days. Include mill test certificate. Packaging: palletized & shrink-wrapped.</p>
          </div>

          <!-- Items Table (URL images) -->
          <table id="poTable">
            <colgroup>
              <col style="width:50px">
              <col style="width:140px">
              <col style="width:360px">
              <col style="width:120px">
              <col style="width:120px">
              <col style="width:140px">
            </colgroup>
            <thead>
              <tr>
                <th>#</th>
                <th>Image</th>
                <th>Description</th>
                <th class="right">Qty</th>
                <th class="right">Unit Price</th>
                <th class="right">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="center">1</td>
                <td class="center">
                  <div class="imgbox">
                    <img alt="Item A" crossorigin="anonymous"
                         src="https://picsum.photos/id/1015/600/400">
                  </div>
                </td>
                <td>Stainless Steel Flat Bar 0.5mm × 4B 304 (Cold Drawn)</td>
                <td class="right">10</td>
                <td class="right">25.00</td>
                <td class="right">250.00</td>
              </tr>
              <tr>
                <td class="center">2</td>
                <td class="center">
                  <div class="imgbox">
                    <img alt="Item B" crossorigin="anonymous"
                         src="https://picsum.photos/id/1025/600/400">
                  </div>
                </td>
                <td>Carbon Steel Sheet HR 6mm × 4' × 8'</td>
                <td class="right">3</td>
                <td class="right">120.00</td>
                <td class="right">360.00</td>
              </tr>
              <tr>
                <td class="center">3</td>
                <td class="center">
                  <div class="imgbox">
                    <img alt="Item C" crossorigin="anonymous"
                         src="https://picsum.photos/id/1035/600/400">
                  </div>
                </td>
                <td>Aluminium Angle 20×20×2mm, Anodized Matte</td>
                <td class="right">5</td>
                <td class="right">18.50</td>
                <td class="right">92.50</td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="5" class="right"><strong>Total</strong></td>
                <td class="right"><strong>702.50</strong></td>
              </tr>
            </tfoot>
          </table>

          <!-- Footer -->
          <div class="footer">
            <div class="footnote">
              Prepared by: Purchasing Dept · Terms: 30 days · Thank you for your business.
            </div>
            <div class="footlogo">
              <img alt="Footer Logo" crossorigin="anonymous"
                   src="https://picsum.photos/seed/logo2/256/64">
            </div>
          </div>

          <p class="note" style="margin-top:8px">
            Note: To embed URL images into Excel offline, the image hosts must allow CORS
            (<code>Access-Control-Allow-Origin: *</code>) or be same-origin.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ExcelJS bundled for offline use -->
  <script src="./vendor/exceljs.min.js"></script>

  <script>
    // Helpers
    const saveAsBlob = (blob, filename) => {
      const a=document.createElement('a'); a.download=filename; a.href=URL.createObjectURL(blob);
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    };
    const pxToExcelColWidth = px => Math.max(6, Math.round((px - 12) / 7));   // Excel col width approx
    const pxToPt = px => Math.round((px * 72 / 96) * 100) / 100;               // row height needs points

    async function urlToDataURL(url){
      try{
        const resp = await fetch(url, {mode:'cors', credentials:'omit'});
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const blob = await resp.blob();
        const reader = new FileReader();
        return await new Promise((resolve,reject)=>{
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }catch(err){
        console.warn('Image fetch blocked:', url, err.message);
        return null;
      }
    }
    const dataURLext = d =>
      d?.startsWith('data:image/jpeg')||d?.startsWith('data:image/jpg') ? 'jpeg' :
      d?.startsWith('data:image/webp') ? 'webp' :
      d?.startsWith('data:image/gif')  ? 'gif'  : 'png';
  </script>

  <script>
  (function(){
    const $ = (selector, root = document) => root.querySelector(selector);
    const $$ = (selector, root = document) => Array.from(root.querySelectorAll(selector));
    const tableEl = $('#poTable');
    const exportBtn = $('#exportBtn');
    const statusEl = $('#status');
    const setStatus = text => {
      if (statusEl) {
        statusEl.textContent = text || '';
      }
    };
    const grid = { style: 'thin', color: { argb: 'FF000000' } };

    if (!exportBtn) {
      return;
    }

    (async () => {
      const imgs = tableEl ? $$('img', tableEl) : [];
      if (!imgs.length) {
        exportBtn.disabled = false;
        return;
      }
      exportBtn.disabled = true;
      setStatus('Loading images...');
      await Promise.all(imgs.map(img => new Promise(resolve => {
        if (img.complete && img.naturalWidth) {
          return resolve();
        }
        img.addEventListener('load', resolve, { once: true });
        img.addEventListener('error', resolve, { once: true });
        setTimeout(resolve, 2000);
      })));
      exportBtn.disabled = false;
      setStatus('');
    })();

    exportBtn.addEventListener('click', async () => {
      try {
        exportBtn.disabled = true;
        setStatus('Preparing Excel workbook...');

        const wb = new ExcelJS.Workbook();
        wb.creator = 'HTML to Excel';
        wb.created = new Date();

        const sheet = wb.addWorksheet('Purchase Order', {
          properties: { defaultRowHeight: 20 }
        });

        const columns = buildColumns(tableEl);
        if (columns.length) {
          sheet.columns = columns;
        }

        const imageJobs = [];

        buildLetterhead(sheet, imageJobs);
        buildInfo(sheet);
        buildRemarks(sheet);
        buildTable(sheet, tableEl, imageJobs);
        buildFooter(sheet, imageJobs);

        setStatus('Embedding images...');
        const blocked = await embedImages(wb, imageJobs);

        setStatus('Writing .xlsx file...');
        const buffer = await wb.xlsx.writeBuffer();
        const blob = new Blob([buffer], {
          type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        });
        saveAsBlob(blob, 'purchase_order.xlsx');
        setStatus(blocked ? `Done, but ${blocked} image(s) were blocked by CORS.` : 'Export complete.');
      } catch (err) {
        console.error(err);
        setStatus('Export failed: ' + err.message);
      } finally {
        exportBtn.disabled = false;
      }
    });

    function buildColumns(table) {
      if (!table) {
        return new Array(6).fill(0).map(() => ({ width: 18 }));
      }
      const headerRow = table.querySelector('thead tr');
      if (!headerRow) {
        return new Array(6).fill(0).map(() => ({ width: 18 }));
      }
      const colEls = table.querySelectorAll('colgroup col');
      const ths = headerRow.children;
      const cols = [];
      if (colEls.length === ths.length) {
        colEls.forEach(col => {
          const widthPx = parseFloat((col.style.width || '').replace('px', '')) || 120;
          cols.push({ width: pxToExcelColWidth(widthPx) });
        });
      } else {
        Array.from(ths).forEach(th => {
          const rect = th.getBoundingClientRect();
          const widthPx = rect.width || 120;
          cols.push({ width: pxToExcelColWidth(widthPx) });
        });
      }
      return cols;
    }

    function buildLetterhead(sheet, imageJobs) {
      const letterhead = $('.letterhead');
      if (!letterhead) {
        return;
      }

      sheet.mergeCells('A1:B4');
      sheet.mergeCells('C1:E2');
      sheet.mergeCells('C3:E4');
      sheet.mergeCells('F1:F2');
      sheet.mergeCells('F3:F4');

      const companyName = letterhead.querySelector('.company h1')?.textContent.trim() || '';
      const companySub = letterhead.querySelector('.company .sub')?.textContent.trim() || '';
      const docTitle = letterhead.querySelector('.doc-title h2')?.textContent.trim() || '';
      const docCode = letterhead.querySelector('.doc-title .code')?.textContent.trim() || '';

      sheet.getCell('C1').value = companyName;
      sheet.getCell('C1').font = { bold: true, size: 16 };
      sheet.getCell('C1').alignment = { vertical: 'middle' };

      sheet.getCell('C3').value = companySub;
      sheet.getCell('C3').alignment = { wrapText: true, vertical: 'top' };

      sheet.getCell('F1').value = docTitle;
      sheet.getCell('F1').font = { bold: true, size: 14 };
      sheet.getCell('F1').alignment = { horizontal: 'right', vertical: 'middle' };

      sheet.getCell('F3').value = docCode;
      sheet.getCell('F3').alignment = { horizontal: 'right', vertical: 'middle' };

      sheet.getRow(1).height = pxToPt(80);
      sheet.getRow(2).height = pxToPt(24);
      sheet.getRow(3).height = pxToPt(24);
      sheet.getRow(4).height = pxToPt(18);

      const logoImg = letterhead.querySelector('.logo img');
      if (logoImg && logoImg.src) {
        const rect = logoImg.getBoundingClientRect();
        const wPx = Math.max(80, Math.min(rect.width || 160, logoImg.naturalWidth || 160));
        const hPx = Math.max(40, Math.min(rect.height || 80, logoImg.naturalHeight || 80));
        sheet.getRow(1).height = Math.max(sheet.getRow(1).height || 0, pxToPt(hPx + 12));
        imageJobs.push({
          sheet: sheet.name,
          row: 1,
          col: 1,
          wPx,
          hPx,
          src: logoImg.src,
          offsetCol: 0.05,
          offsetRow: 0.05
        });
      }
    }

    function buildInfo(sheet) {
      const infoPairs = Array.from(document.querySelectorAll('.info .k')).map(k => ({
        key: k.textContent.trim(),
        value: k.nextElementSibling ? k.nextElementSibling.textContent.trim() : ''
      }));
      if (!infoPairs.length) {
        return;
      }
      sheet.addRow([]);
      const spacer = sheet.addRow([]);
      sheet.getRow(spacer.number).height = pxToPt(6);
      for (let i = 0; i < infoPairs.length; i += 2) {
        const row = sheet.addRow([]);
        const rowNumber = row.number;
        sheet.getCell(rowNumber, 1).value = infoPairs[i].key;
        sheet.getCell(rowNumber, 1).font = { bold: true };
        sheet.mergeCells(rowNumber, 2, rowNumber, 3);
        sheet.getCell(rowNumber, 2).value = infoPairs[i].value;
        sheet.getCell(rowNumber, 2).alignment = { wrapText: true };
        if (infoPairs[i + 1]) {
          sheet.getCell(rowNumber, 4).value = infoPairs[i + 1].key;
          sheet.getCell(rowNumber, 4).font = { bold: true };
          sheet.mergeCells(rowNumber, 5, rowNumber, 6);
          sheet.getCell(rowNumber, 5).value = infoPairs[i + 1].value;
          sheet.getCell(rowNumber, 5).alignment = { wrapText: true };
        }
        sheet.getRow(rowNumber).height = pxToPt(22);
      }
    }

    function buildRemarks(sheet) {
      const remarks = document.querySelector('.remarks p');
      if (!remarks) {
        return;
      }
      sheet.addRow([]);
      const titleRow = sheet.addRow(['']);
      const titleRowNumber = titleRow.number;
      sheet.mergeCells(titleRowNumber, 1, titleRowNumber, 6);
      const titleCell = sheet.getCell(titleRowNumber, 1);
      titleCell.value = 'Remarks';
      titleCell.font = { bold: true };
      titleCell.alignment = { vertical: 'middle' };
      titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFCFCFC' } };
      titleCell.border = { top: grid, left: grid, right: grid };

      const textRow = sheet.addRow(['']);
      const textRowNumber = textRow.number;
      sheet.mergeCells(textRowNumber, 1, textRowNumber, 6);
      const textCell = sheet.getCell(textRowNumber, 1);
      textCell.value = remarks.textContent.trim();
      textCell.alignment = { wrapText: true };
      textCell.border = { left: grid, right: grid, bottom: grid };
      sheet.getRow(textRowNumber).height = pxToPt(Math.max(remarks.parentElement?.getBoundingClientRect().height || 36, 36));
    }

    function buildTable(sheet, table, imageJobs) {
      if (!table) {
        return;
      }
      sheet.addRow([]);
      const theadRow = table.querySelector('thead tr');
      if (!theadRow) {
        return;
      }
      const headerVals = Array.from(theadRow.children).map(th => th.textContent.trim());
      const headerRow = sheet.addRow(headerVals);
      headerRow.eachCell((cell, colNumber) => {
        styleCell(cell, theadRow.children[colNumber - 1], true);
      });
      headerRow.height = pxToPt(Math.max(theadRow.getBoundingClientRect().height, 24));

      const bodyRows = table.querySelectorAll('tbody tr');
      bodyRows.forEach(tr => {
        const tds = Array.from(tr.children);
        const values = tds.map(td => td.querySelector('img') ? '' : parseCellValue(td.textContent));
        const row = sheet.addRow(values);
        row.eachCell((cell, colNumber) => {
          styleCell(cell, tds[colNumber - 1], false);
          if (typeof cell.value === 'number') {
            cell.numFmt = '0.00';
          }
        });
        row.height = pxToPt(Math.max(tr.getBoundingClientRect().height, 36));

        tds.forEach((td, idx) => {
          const img = td.querySelector('img');
          if (!img || !img.src) {
            return;
          }
          const box = td.querySelector('.imgbox') || td;
          const rect = box.getBoundingClientRect();
          const wPx = Math.max(24, Math.min(rect.width || 120, img.naturalWidth || 120));
          const hPx = Math.max(24, Math.min(rect.height || 120, img.naturalHeight || 120));
          imageJobs.push({
            sheet: sheet.name,
            row: row.number,
            col: idx + 1,
            wPx,
            hPx,
            src: img.src,
            offsetCol: 0.05,
            offsetRow: 0.05
          });
          const requiredHeight = pxToPt(hPx + 8);
          const currentHeight = sheet.getRow(row.number).height || 0;
          sheet.getRow(row.number).height = Math.max(currentHeight, requiredHeight);
        });
      });

      const tfootRow = table.querySelector('tfoot tr');
      if (tfootRow) {
        const cells = Array.from(tfootRow.children);
        const values = cells.map(td => parseCellValue(td.textContent));
        const row = sheet.addRow(values);
        row.eachCell((cell, colNumber) => {
          styleCell(cell, cells[colNumber - 1], false);
          if (/total/i.test(cells[colNumber - 1].textContent)) {
            cell.font = { bold: true };
          }
          if (typeof cell.value === 'number') {
            cell.numFmt = '0.00';
          }
        });
        row.height = pxToPt(Math.max(tfootRow.getBoundingClientRect().height, 24));
      }
    }

    function buildFooter(sheet, imageJobs) {
      const footer = $('.footer');
      if (footer) {
        const footnote = footer.querySelector('.footnote');
        const footLogo = footer.querySelector('.footlogo img');
        sheet.addRow([]);
        if (footnote) {
          const row = sheet.addRow(['']);
          const rowNumber = row.number;
          sheet.mergeCells(rowNumber, 1, rowNumber, 5);
          const cell = sheet.getCell(rowNumber, 1);
          cell.value = footnote.textContent.trim();
          cell.alignment = { wrapText: true };
          cell.font = { size: 11 };
          sheet.getRow(rowNumber).height = pxToPt(Math.max(footnote.getBoundingClientRect().height, 20));
          cell.border = { top: grid };
          if (footLogo && footLogo.src) {
            const rect = footLogo.getBoundingClientRect();
            const wPx = Math.max(60, Math.min(rect.width || 120, footLogo.naturalWidth || 120));
            const hPx = Math.max(24, Math.min(rect.height || 60, footLogo.naturalHeight || 60));
            imageJobs.push({
              sheet: sheet.name,
              row: rowNumber,
              col: 6,
              wPx,
              hPx,
              src: footLogo.src,
              offsetCol: 0.1,
              offsetRow: 0.1
            });
            const existing = sheet.getRow(rowNumber).height || 0;
            sheet.getRow(rowNumber).height = Math.max(existing, pxToPt(hPx + 8));
          }
        }
      }

      const noteElement = $('.note');
      if (noteElement) {
        const row = sheet.addRow(['']);
        const rowNumber = row.number;
        sheet.mergeCells(rowNumber, 1, rowNumber, 6);
        const cell = sheet.getCell(rowNumber, 1);
        cell.value = noteElement.textContent.trim();
        cell.alignment = { wrapText: true };
        cell.font = { italic: true, color: { argb: 'FF555555' }, size: 11 };
        sheet.getRow(rowNumber).height = pxToPt(Math.max(noteElement.getBoundingClientRect().height, 24));
      }
    }

    function styleCell(cell, el, isHeader) {
      let align = isHeader ? 'center' : 'left';
      if (el) {
        const cs = getComputedStyle(el);
        align = cs.textAlign || align;
      }
      cell.alignment = {
        horizontal: /right/i.test(align) ? 'right' : (/center/i.test(align) ? 'center' : 'left'),
        vertical: isHeader ? 'middle' : 'top',
        wrapText: true
      };
      cell.border = { top: grid, left: grid, right: grid, bottom: grid };
      if (isHeader) {
        cell.font = { bold: true };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE9ECEF' } };
      }
    }

    function parseCellValue(text) {
      const trimmed = text.trim();
      return /^-?\d+(\.\d+)?$/.test(trimmed) ? Number(trimmed) : trimmed;
    }

    async function embedImages(wb, jobs) {
      let blocked = 0;
      for (const job of jobs) {
        const dataURL = await urlToDataURL(job.src);
        if (!dataURL) {
          blocked += 1;
          continue;
        }
        const imgId = wb.addImage({
          base64: dataURL,
          extension: dataURLext(dataURL)
        });
        const ws = wb.getWorksheet(job.sheet);
        if (!ws) {
          continue;
        }
        ws.addImage(imgId, {
          tl: {
            col: (job.col - 1) + (job.offsetCol || 0),
            row: (job.row - 1) + (job.offsetRow || 0)
          },
          ext: {
            width: job.wPx,
            height: job.hPx
          },
          editAs: 'oneCell'
        });
      }
      return blocked;
    }
  })();
  </script>
</body>
</html>
